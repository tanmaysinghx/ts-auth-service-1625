name: CICD

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout source code
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install doctl
        run: |
          # Download doctl and make it executable
          curl -sSL https://github.com/digitalocean/doctl/releases/latest/download/doctl-$(uname -s)-$(uname -m).tar.gz | tar xz
          sudo mv doctl /usr/local/bin
          sudo chmod +x /usr/local/bin/doctl

      - name: Authenticate doctl
        run: |
          echo "${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}" | doctl auth init -t

      - name: Set up SSH Key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Pull Latest Docker Image
        run: |
          doctl compute ssh 449640053 --ssh-key-path ~/.ssh/id_rsa -- \
          'docker pull tanmaysinghx/ts-auth-service-1625:latest'
          
      - name: Restart Docker Container
        run: |
          doctl compute ssh 449640053 --ssh-key-path ~/.ssh/id_rsa -- \
          'docker rm -f ts-auth-service-1625 || true && \
           docker run -d -p 8080:8080 --name ts-auth-service-1625 tanmaysinghx/ts-auth-service-1625:latest'
